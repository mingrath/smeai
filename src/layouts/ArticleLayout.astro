---
import { getEntry } from 'astro:content';
import BaseLayout from './BaseLayout.astro';
import ArticleMeta from '../components/article/ArticleMeta.astro';
import TableOfContents from '../components/article/TableOfContents.astro';
import ArticleJsonLd from '../components/seo/ArticleJsonLd.astro';
import YouTubeFacade from '../components/video/YouTubeFacade.astro';
import type { CollectionEntry } from 'astro:content';

interface Props {
	article: CollectionEntry<'articles'>;
	headings: { depth: number; slug: string; text: string }[];
	readingTime: number;
}

const { article, headings, readingTime } = Astro.props;
const { data } = article;

const pageTitle = data.seoTitle || data.title;
const articleURL = new URL(Astro.url.pathname, Astro.site).href;
const linkedVideo = article.data.video
	? await getEntry(article.data.video)
	: null;
---

<BaseLayout
	title={pageTitle}
	description={data.description}
	ogType="article"
	publishedTime={data.pubDate}
	modifiedTime={data.lastReviewed}
	tags={data.tags}
>
	<ArticleJsonLd
		title={data.title}
		description={data.description}
		pubDate={data.pubDate}
		lastReviewed={data.lastReviewed}
		url={articleURL}
		category={data.category}
		tags={data.tags}
	/>

	<article class="py-12 md:py-16" data-pagefind-body>
		<div class="prose-container">
			<!-- Article title -->
			<h1 class="text-3xl md:text-4xl font-bold text-surface-900 dark:text-surface-100 mb-6 leading-tight" data-pagefind-meta="title">
				{data.title}
			</h1>

			<!-- Content type filter for search -->
			<span data-pagefind-filter="content_type" class="hidden">article</span>

			<!-- Meta info (reading time, dates, category, tags) -->
			<div data-pagefind-ignore>
				<ArticleMeta
					readingTime={readingTime}
					pubDate={data.pubDate}
					lastReviewed={data.lastReviewed}
					category={data.category}
					tags={data.tags}
				/>
			</div>

			<!-- Video embed (if article has linked video) -->
			{linkedVideo && (
				<div class="mb-8" data-pagefind-ignore>
					<YouTubeFacade videoId={linkedVideo.data.youtubeId} title={linkedVideo.data.title} />
					<p class="text-sm text-surface-500 dark:text-surface-400 mt-2">
						ดูวิดีโอประกอบ:{' '}
						<a href={`/videos/${linkedVideo.id}/`} class="text-primary-600 dark:text-primary-400 hover:underline">
							{linkedVideo.data.title}
						</a>
					</p>
				</div>
			)}

			<!-- Table of Contents -->
			<div data-pagefind-ignore>
				<TableOfContents headings={headings} />
			</div>

			<!-- Article body -->
			<div class="prose prose-lg dark:prose-invert max-w-none">
				<slot />
			</div>

			<!-- Back to articles link -->
			<div class="mt-12 pt-6 border-t border-surface-200 dark:border-surface-700" data-pagefind-ignore>
				<a
					href="/articles/"
					class="inline-flex items-center gap-2 text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 font-medium transition-colors"
				>
					<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
						<path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
					</svg>
					กลับไปหน้าบทความ
				</a>
			</div>
		</div>
	</article>
</BaseLayout>
