# Phase 3, Plan 02: Article Pages, SEO Enhancement & Layout

**Phase Goal**: Ohm can publish Thai-language articles via Markdown with validated frontmatter, and visitors can browse articles by category, read with a polished experience, and subscribe via RSS
**Plan Scope**: Enhance BaseLayout with canonical URLs and full OG tags, create the ArticleLayout with table of contents, reading time, lastReviewed display, and JSON-LD structured data, build the individual article page route
**Requirements**: CONT-02 (TOC, reading time, visual breaks), CONT-03 (Thai-primary with Tinglish SEO), CONT-04 (lastReviewed date), SEO-01 (meta tags, OG, canonical), SEO-02 (Article + BreadcrumbList structured data)
**Depends on**: 03-01 (content collection, seed articles, remark plugin)

## Context

Plan 01 established the content collection with Zod schema, the Thai-aware reading time remark plugin, 2 seed articles, the RSS endpoint, and sitemap integration. This plan builds the reading experience: enhanced SEO head tags on all pages, and the full article page with table of contents, meta info, and structured data.

Key references:
- `@src/layouts/BaseLayout.astro` -- enhance with new Props + OG tags + canonical
- `@src/styles/global.css` -- has prose customization already
- `@src/lib/categories.ts` -- created in Plan 01
- `@.planning/phases/03-content-system-and-articles/03-RESEARCH.md` -- JSON-LD patterns, TOC buildToc()

## Tasks

### Task 1: Enhance BaseLayout with SEO Props and Create SEO Components

**What:** Extend BaseLayout.astro Props interface with OG/article fields, add canonical URL, full Open Graph tags, article-specific OG tags, RSS auto-discovery link, and sitemap link. Create the ArticleJsonLd component for structured data.

**Why:** SEO-01 requires every page to have canonical URLs, og:locale=th_TH (already exists), and full Open Graph tags. SEO-02 requires Article + BreadcrumbList JSON-LD on article pages. The BaseLayout enhancement affects all pages site-wide.

**Files:**
- `src/layouts/BaseLayout.astro` -- extend Props, add canonical + OG + RSS + sitemap links
- `src/components/seo/ArticleJsonLd.astro` -- create Article + BreadcrumbList JSON-LD component

**Details:**

**Step 1: Update `src/layouts/BaseLayout.astro`**

Extend the Props interface to accept optional SEO fields. Add canonical URL, Open Graph meta tags, article-specific OG tags, RSS auto-discovery, and sitemap link to the `<head>`. Keep all existing functionality (dark mode script, fonts, header/footer).

The updated Props interface:

```typescript
interface Props {
  title: string;
  description?: string;
  ogType?: 'website' | 'article';
  ogImage?: string;
  publishedTime?: Date;
  modifiedTime?: Date;
  tags?: string[];
}
```

The updated `<head>` section (replace the existing `<head>` entirely):

```html
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content={description} />
  <link rel="canonical" href={canonicalURL} />

  <!-- Open Graph -->
  <meta property="og:title" content={`${title} | SMEAI`} />
  <meta property="og:description" content={description} />
  <meta property="og:type" content={ogType} />
  <meta property="og:url" content={canonicalURL} />
  <meta property="og:locale" content="th_TH" />
  <meta property="og:site_name" content="SMEAI" />
  {ogImageURL && <meta property="og:image" content={ogImageURL} />}

  <!-- Article-specific OG tags (only when ogType is 'article') -->
  {ogType === 'article' && publishedTime && (
    <meta property="article:published_time" content={publishedTime.toISOString()} />
  )}
  {ogType === 'article' && modifiedTime && (
    <meta property="article:modified_time" content={modifiedTime.toISOString()} />
  )}
  {ogType === 'article' && tags.map((tag) => (
    <meta property="article:tag" content={tag} />
  ))}

  <!-- RSS auto-discovery -->
  <link
    rel="alternate"
    type="application/rss+xml"
    title="SMEAI Articles"
    href={new URL('rss.xml', Astro.site)}
  />

  <!-- Sitemap -->
  <link rel="sitemap" href="/sitemap-index.xml" />

  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <title>{title} | SMEAI</title>

  <!-- Dark mode (keep existing script unchanged) -->
  <script is:inline>
    (function () {
      const theme = localStorage.getItem('theme');
      if (theme === 'dark' || (!theme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    })();
  </script>
</head>
```

Compute `canonicalURL` and `ogImageURL` in the frontmatter script:

```typescript
const {
  title,
  description = 'AI สำหรับ SME ไทย - เรียนรู้และปรึกษา',
  ogType = 'website',
  ogImage,
  publishedTime,
  modifiedTime,
  tags = [],
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const ogImageURL = ogImage ? new URL(ogImage, Astro.site) : undefined;
```

Keep the rest of the body (`<Header />`, `<MobileNav />`, `<main>`, `<Footer />`) exactly as-is.

**Step 2: Create `src/components/seo/ArticleJsonLd.astro`**

This component emits a `<script type="application/ld+json">` tag containing both an Article schema and a BreadcrumbList schema in a `@graph` array. MUST use `set:html={JSON.stringify(schema)}` to avoid HTML escaping of the JSON.

```astro
---
import { getCategoryName } from '../../lib/categories';
import type { CategorySlug } from '../../lib/categories';

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  lastReviewed: Date;
  url: string;
  category: CategorySlug;
  tags: string[];
}

const { title, description, pubDate, lastReviewed, url, category, tags } = Astro.props;

const schema = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Article",
      "headline": title,
      "description": description,
      "datePublished": pubDate.toISOString().substring(0, 10),
      "dateModified": lastReviewed.toISOString().substring(0, 10),
      "author": {
        "@type": "Person",
        "name": "Mingrath Mekavichai",
      },
      "publisher": {
        "@type": "Organization",
        "name": "SMEAI",
        "url": Astro.site?.href,
      },
      "mainEntityOfPage": url,
      "keywords": tags,
      "inLanguage": "th",
    },
    {
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "หน้าแรก",
          "item": new URL("/", Astro.site).href,
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "บทความ",
          "item": new URL("/articles/", Astro.site).href,
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": getCategoryName(category),
          "item": new URL(`/articles/category/${category}/`, Astro.site).href,
        },
        {
          "@type": "ListItem",
          "position": 4,
          "name": title,
        },
      ],
    },
  ],
};
---

<script type="application/ld+json" set:html={JSON.stringify(schema)} />
```

**Verification:**
- [ ] `npm run build` passes
- [ ] View source of built homepage (`dist/index.html`): has `<link rel="canonical"`, `og:title`, `og:type` content="website", `og:locale` content="th_TH", `og:site_name` content="SMEAI", RSS auto-discovery link, sitemap link
- [ ] View source of built contact page: same SEO tags present
- [ ] `src/components/seo/ArticleJsonLd.astro` exists with `set:html` directive

---

### Task 2: Create ArticleLayout, Article Sub-Components, and Article Page Route

**What:** Create the ArticleLayout.astro wrapper, TableOfContents.astro, ArticleMeta.astro components, and the `[slug].astro` dynamic route for individual article pages.

**Why:** CONT-02 requires TOC, reading time, and visual breaks. CONT-04 requires lastReviewed date displayed prominently. CONT-03 requires Thai-primary with Tinglish SEO (seoTitle used in `<title>` when present). This task wires everything together into the actual article reading experience.

**Files:**
- `src/components/article/TableOfContents.astro` -- create TOC component from headings array
- `src/components/article/ArticleMeta.astro` -- create reading time + dates display
- `src/layouts/ArticleLayout.astro` -- create article page wrapper layout
- `src/pages/articles/[slug].astro` -- create dynamic article page route

**Details:**

**Step 1: Create `src/components/article/TableOfContents.astro`**

Takes the `headings` array from `render()` (each heading has `depth`, `slug`, `text`). Uses the `buildToc()` utility to create a nested structure. Renders as a sticky sidebar-friendly `<nav>` with nested `<ul>`. Only renders if there are h2+ headings. Handles h2 and h3 nesting (deeper headings ignored for simplicity).

```astro
---
interface TocHeading {
  depth: number;
  slug: string;
  text: string;
  subheadings: TocHeading[];
}

interface Props {
  headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;

function buildToc(
  headings: { depth: number; slug: string; text: string }[]
): TocHeading[] {
  const toc: TocHeading[] = [];
  const parentHeadings = new Map<number, TocHeading>();

  for (const h of headings) {
    if (h.depth < 2 || h.depth > 3) continue;
    const heading: TocHeading = { ...h, subheadings: [] };
    parentHeadings.set(heading.depth, heading);
    if (heading.depth === 2) {
      toc.push(heading);
    } else {
      parentHeadings.get(heading.depth - 1)?.subheadings.push(heading);
    }
  }

  return toc;
}

const toc = buildToc(headings);
---

{toc.length > 0 && (
  <nav aria-label="สารบัญ" class="mb-8 p-4 rounded-xl bg-surface-100 dark:bg-surface-800/50 border border-surface-200 dark:border-surface-700">
    <h2 class="text-sm font-semibold text-surface-900 dark:text-surface-100 uppercase tracking-wider mb-3">
      สารบัญ
    </h2>
    <ul class="space-y-1.5 text-sm">
      {toc.map((heading) => (
        <li>
          <a
            href={`#${heading.slug}`}
            class="text-surface-600 hover:text-primary-600 dark:text-surface-400 dark:hover:text-primary-400 transition-colors"
          >
            {heading.text}
          </a>
          {heading.subheadings.length > 0 && (
            <ul class="ml-4 mt-1.5 space-y-1.5">
              {heading.subheadings.map((sub) => (
                <li>
                  <a
                    href={`#${sub.slug}`}
                    class="text-surface-500 hover:text-primary-600 dark:text-surface-400 dark:hover:text-primary-400 transition-colors"
                  >
                    {sub.text}
                  </a>
                </li>
              ))}
            </ul>
          )}
        </li>
      ))}
    </ul>
  </nav>
)}
```

**Step 2: Create `src/components/article/ArticleMeta.astro`**

Displays reading time, publish date, last reviewed date, category badge, and tags. Uses Thai date formatting with `toLocaleDateString('th-TH', ...)`. Shows lastReviewed prominently (CONT-04).

```astro
---
import { getCategoryName } from '../../lib/categories';
import type { CategorySlug } from '../../lib/categories';

interface Props {
  readingTime: number;
  pubDate: Date;
  lastReviewed: Date;
  category: CategorySlug;
  tags: string[];
}

const { readingTime, pubDate, lastReviewed, category, tags } = Astro.props;

const dateOptions: Intl.DateTimeFormatOptions = {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
};

const pubDateFormatted = pubDate.toLocaleDateString('th-TH', dateOptions);
const lastReviewedFormatted = lastReviewed.toLocaleDateString('th-TH', dateOptions);
---

<div class="mb-8 pb-6 border-b border-surface-200 dark:border-surface-700">
  <!-- Category badge + reading time -->
  <div class="flex flex-wrap items-center gap-3 mb-3 text-sm">
    <a
      href={`/articles/category/${category}/`}
      class="inline-flex items-center px-3 py-1 rounded-full bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 font-medium hover:bg-primary-200 dark:hover:bg-primary-900/50 transition-colors"
    >
      {getCategoryName(category)}
    </a>
    <span class="flex items-center gap-1 text-surface-500 dark:text-surface-400">
      <!-- Clock icon (Heroicons outline) -->
      <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
      </svg>
      อ่าน {readingTime} นาที
    </span>
  </div>

  <!-- Dates -->
  <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-surface-500 dark:text-surface-400">
    <span>เผยแพร่: {pubDateFormatted}</span>
    <span class="flex items-center gap-1 text-primary-600 dark:text-primary-400 font-medium">
      <!-- Check badge icon -->
      <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12c0 1.268-.63 2.39-1.593 3.068a3.745 3.745 0 0 1-1.043 3.296 3.745 3.745 0 0 1-3.296 1.043A3.745 3.745 0 0 1 12 21c-1.268 0-2.39-.63-3.068-1.593a3.746 3.746 0 0 1-3.296-1.043 3.745 3.745 0 0 1-1.043-3.296A3.745 3.745 0 0 1 3 12c0-1.268.63-2.39 1.593-3.068a3.745 3.745 0 0 1 1.043-3.296 3.746 3.746 0 0 1 3.296-1.043A3.746 3.746 0 0 1 12 3c1.268 0 2.39.63 3.068 1.593a3.746 3.746 0 0 1 3.296 1.043 3.745 3.745 0 0 1 1.043 3.296A3.745 3.745 0 0 1 21 12Z" />
      </svg>
      ตรวจสอบล่าสุด: {lastReviewedFormatted}
    </span>
  </div>

  <!-- Tags -->
  {tags.length > 0 && (
    <div class="flex flex-wrap gap-2 mt-3">
      {tags.map((tag) => (
        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-surface-200 dark:bg-surface-700 text-surface-600 dark:text-surface-300">
          #{tag}
        </span>
      ))}
    </div>
  )}
</div>
```

**Step 3: Create `src/layouts/ArticleLayout.astro`**

Wraps BaseLayout. Receives the article entry, headings array, and reading time from the page. Renders the article title, ArticleMeta, TableOfContents, prose-styled content, and ArticleJsonLd. Uses `prose-container` class from global.css for the content column. If `seoTitle` exists in frontmatter, use it for the page `<title>`; otherwise use the Thai `title`.

```astro
---
import BaseLayout from './BaseLayout.astro';
import ArticleMeta from '../components/article/ArticleMeta.astro';
import TableOfContents from '../components/article/TableOfContents.astro';
import ArticleJsonLd from '../components/seo/ArticleJsonLd.astro';
import type { CollectionEntry } from 'astro:content';

interface Props {
  article: CollectionEntry<'articles'>;
  headings: { depth: number; slug: string; text: string }[];
  readingTime: number;
}

const { article, headings, readingTime } = Astro.props;
const { data } = article;

const pageTitle = data.seoTitle || data.title;
const articleURL = new URL(Astro.url.pathname, Astro.site).href;
---

<BaseLayout
  title={pageTitle}
  description={data.description}
  ogType="article"
  publishedTime={data.pubDate}
  modifiedTime={data.lastReviewed}
  tags={data.tags}
>
  <ArticleJsonLd
    title={data.title}
    description={data.description}
    pubDate={data.pubDate}
    lastReviewed={data.lastReviewed}
    url={articleURL}
    category={data.category}
    tags={data.tags}
  />

  <article class="py-12 md:py-16">
    <div class="prose-container">
      <!-- Article title -->
      <h1 class="text-3xl md:text-4xl font-bold text-surface-900 dark:text-surface-100 mb-6 leading-tight">
        {data.title}
      </h1>

      <!-- Meta info (reading time, dates, category, tags) -->
      <ArticleMeta
        readingTime={readingTime}
        pubDate={data.pubDate}
        lastReviewed={data.lastReviewed}
        category={data.category}
        tags={data.tags}
      />

      <!-- Table of Contents -->
      <TableOfContents headings={headings} />

      <!-- Article body -->
      <div class="prose prose-lg dark:prose-invert max-w-none">
        <slot />
      </div>

      <!-- Back to articles link -->
      <div class="mt-12 pt-6 border-t border-surface-200 dark:border-surface-700">
        <a
          href="/articles/"
          class="inline-flex items-center gap-2 text-primary-600 dark:text-primary-400 hover:text-primary-700 dark:hover:text-primary-300 font-medium transition-colors"
        >
          <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" />
          </svg>
          กลับไปหน้าบทความ
        </a>
      </div>
    </div>
  </article>
</BaseLayout>
```

**Step 4: Create `src/pages/articles/[slug].astro`**

Uses `getStaticPaths()` to generate a page for each non-draft article. The slug is derived from `article.id.split('/').pop()` (the filename portion without the category directory). Calls `render()` to get Content, headings, and remarkPluginFrontmatter (which contains `minutesRead` from the remark plugin).

```astro
---
import { getCollection, render } from 'astro:content';
import ArticleLayout from '../../layouts/ArticleLayout.astro';

export async function getStaticPaths() {
  const articles = await getCollection('articles', ({ data }) => !data.draft);
  return articles.map((article) => ({
    params: { slug: article.id.split('/').pop()! },
    props: { article },
  }));
}

const { article } = Astro.props;
const { Content, headings, remarkPluginFrontmatter } = await render(article);
---

<ArticleLayout
  article={article}
  headings={headings}
  readingTime={remarkPluginFrontmatter.minutesRead}
>
  <Content />
</ArticleLayout>
```

**Verification:**
- [ ] `npm run build` passes with no errors
- [ ] Build output includes `dist/articles/chatgpt-for-sme/index.html` and `dist/articles/line-oa-chatbot/index.html`
- [ ] View source of an article page: has `og:type` content="article", `article:published_time`, `article:tag` meta tags
- [ ] View source of an article page: has `<script type="application/ld+json">` with Article and BreadcrumbList schemas
- [ ] Article page shows: title, category badge, reading time in Thai ("อ่าน X นาที"), publish date, lastReviewed date (in Thai), tags, table of contents, rendered Markdown content, back link
- [ ] Reading time is reasonable (not "1 นาที" for a long article -- should be 3+ minutes for the seed articles)
- [ ] TOC links are anchor links that match heading IDs

## Plan Verification

- [ ] `npm run build` passes
- [ ] Every built HTML page has `<link rel="canonical"` with absolute URL
- [ ] Every built HTML page has `og:title`, `og:description`, `og:type`, `og:url`, `og:locale` content="th_TH", `og:site_name`
- [ ] Article pages additionally have `article:published_time`, `article:modified_time`, `article:tag` OG tags
- [ ] Article pages have JSON-LD with `@type: Article` and `@type: BreadcrumbList`
- [ ] Article pages display table of contents with clickable anchor links
- [ ] Article pages display reading time in Thai ("อ่าน X นาที") with accurate Thai word counting
- [ ] Article pages display lastReviewed date prominently with Thai date formatting
- [ ] Article content renders with proper prose styling (dark mode compatible)
- [ ] `npm run build` still produces valid RSS and sitemap files (from Plan 01)
