---
phase: 06-search-and-performance
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/layouts/BaseLayout.astro
autonomous: true

must_haves:
  truths:
    - "Thai font renders immediately without visible flash (FOIT/FOUT) on first page load"
    - "Lighthouse mobile score is 90+ on landing page, article page, listing page, and contact page"
    - "No render-blocking resources flagged by Lighthouse that can be resolved"
  artifacts:
    - path: "src/layouts/BaseLayout.astro"
      provides: "Font preload link for Thai woff2"
      contains: "rel=\"preload\""
  key_links:
    - from: "src/layouts/BaseLayout.astro"
      to: "@fontsource-variable/noto-sans-thai/files/noto-sans-thai-thai-wght-normal.woff2"
      via: "Vite ?url import producing preload href"
      pattern: "noto-sans-thai.*woff2.*url"
---

<objective>
Preload the primary Thai font file to improve LCP and verify the complete site (including search from 06-01) meets the Lighthouse mobile 90+ threshold.

Purpose: Ensure Core Web Vitals pass for SEO and user experience.
Output: Font preload in BaseLayout, Lighthouse verification across all page types.
</objective>

<execution_context>
@/Users/ohmmingrath/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohmmingrath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-search-and-performance/06-RESEARCH.md
@.planning/phases/06-search-and-performance/06-01-SUMMARY.md

Key existing files:
@src/layouts/BaseLayout.astro
@src/styles/global.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Preload Thai font and audit Lighthouse performance</name>
  <files>
    src/layouts/BaseLayout.astro
  </files>
  <action>
1. Add Thai font preload to BaseLayout.astro `<head>`:
   - Import the Thai woff2 file URL in frontmatter:
     ```typescript
     import notoSansThaiWoff2 from '@fontsource-variable/noto-sans-thai/files/noto-sans-thai-thai-wght-normal.woff2?url';
     ```
   - Add preload link as the FIRST element in `<head>` (before charset):
     ```html
     <link rel="preload" as="font" type="font/woff2" href={notoSansThaiWoff2} crossorigin="anonymous" />
     ```
   - CRITICAL: The `crossorigin="anonymous"` attribute is REQUIRED. Without it, the browser downloads the font twice (once from preload, once from CSS @font-face).
   - Only preload the Thai font (primary). Do NOT preload Inter -- over-preloading hurts performance.

2. Build the site and run Lighthouse audit:
   ```bash
   npm run build
   npm run preview &
   # Wait for server to start
   sleep 2
   ```

   Run Lighthouse CLI (install if needed: `npm install -g lighthouse`):
   ```bash
   # Test key page types
   lighthouse http://localhost:4321/ --output=json --output-path=./lighthouse-home.json --chrome-flags="--headless" --only-categories=performance
   lighthouse http://localhost:4321/articles/ai-chatbot-for-sme/ --output=json --output-path=./lighthouse-article.json --chrome-flags="--headless" --only-categories=performance
   lighthouse http://localhost:4321/articles/ --output=json --output-path=./lighthouse-listing.json --chrome-flags="--headless" --only-categories=performance
   lighthouse http://localhost:4321/contact/ --output=json --output-path=./lighthouse-contact.json --chrome-flags="--headless" --only-categories=performance
   ```

   Extract scores and verify each is 90+. If any score is below 90, investigate the Lighthouse report diagnostics and fix:
   - If render-blocking resources flagged: check if fixable (Fontsource CSS is expected and acceptable)
   - If LCP too slow: verify font preload is working (check Network tab for single font download)
   - If CLS flagged: check for layout shifts from font loading or dynamic content
   - If FCP flagged: verify no unnecessary JS blocking first paint

   Clean up lighthouse JSON files after verification (don't commit them).

3. If Lighthouse is not available or cannot run in this environment, verify font preload correctness by:
   - Running `npm run build` successfully
   - Checking the built HTML in `dist/index.html` for the preload link presence
   - Confirming the font href resolves to a valid hashed asset path
  </action>
  <verify>
    `npm run build` succeeds.
    Built HTML contains `<link rel="preload" as="font" type="font/woff2" ... crossorigin="anonymous" />` with valid href.
    If Lighthouse available: all 4 page types score 90+ on performance (mobile).
    If Lighthouse unavailable: font preload verified in build output, no regression in build.
  </verify>
  <done>
    Thai font is preloaded with correct crossorigin attribute, site builds cleanly with search + preload, Lighthouse mobile performance verified at 90+ (or build output verified if Lighthouse unavailable).
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Built HTML in `dist/index.html` contains font preload link with crossorigin="anonymous"
3. Font preload href points to a valid hashed woff2 file in the dist assets
4. No duplicate font downloads visible in Network waterfall
5. Lighthouse mobile performance score >= 90 on landing, article, listing, and contact pages
</verification>

<success_criteria>
- Core Web Vitals pass: Lighthouse mobile score 90+ across all page types (SEO-06)
- Thai font preloaded to eliminate FOIT/FOUT and improve LCP
- No performance regression from search integration (Pagefind JS loads lazily)
</success_criteria>

<output>
After completion, create `.planning/phases/06-search-and-performance/06-02-SUMMARY.md`
</output>
