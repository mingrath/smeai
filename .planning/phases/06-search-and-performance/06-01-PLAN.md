---
phase: 06-search-and-performance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - astro.config.mjs
  - package.json
  - src/components/search/SearchDialog.astro
  - src/components/common/Header.astro
  - src/layouts/BaseLayout.astro
  - src/layouts/ArticleLayout.astro
  - src/layouts/ProjectLayout.astro
  - src/layouts/VideoLayout.astro
  - src/styles/global.css
autonomous: true

must_haves:
  truths:
    - "Visitor can open search dialog via Cmd/Ctrl+K keyboard shortcut or clicking search icon in header"
    - "Search dialog displays results from articles, projects, and videos but not navigation/footer boilerplate"
    - "Search returns relevant results for Thai text queries and mixed Thai-English queries"
    - "Search UI theme matches site design system in both light and dark modes"
  artifacts:
    - path: "src/components/search/SearchDialog.astro"
      provides: "Search dialog with lazy-loaded Pagefind UI, Cmd/Ctrl+K shortcut, click-outside-to-close"
      min_lines: 40
    - path: "astro.config.mjs"
      provides: "Pagefind integration registered"
      contains: "pagefind()"
    - path: "src/layouts/ArticleLayout.astro"
      provides: "Article content indexed for search"
      contains: "data-pagefind-body"
    - path: "src/layouts/ProjectLayout.astro"
      provides: "Project content indexed for search"
      contains: "data-pagefind-body"
    - path: "src/layouts/VideoLayout.astro"
      provides: "Video content indexed for search"
      contains: "data-pagefind-body"
    - path: "src/styles/global.css"
      provides: "Pagefind CSS custom properties matching OKLCH design tokens"
      contains: "--pagefind-ui-primary"
  key_links:
    - from: "src/components/common/Header.astro"
      to: "SearchDialog"
      via: "Search trigger button dispatches dialog.showModal()"
      pattern: "search-trigger"
    - from: "src/components/search/SearchDialog.astro"
      to: "@pagefind/default-ui"
      via: "Dynamic import on first dialog open"
      pattern: "import.*pagefind.*default-ui"
    - from: "src/layouts/ArticleLayout.astro"
      to: "Pagefind build-time indexer"
      via: "data-pagefind-body attribute on article element"
      pattern: "data-pagefind-body"
---

<objective>
Integrate Pagefind build-time search into the Astro site with Thai language support, a search dialog UI with keyboard shortcut, and proper content indexing across all three content types (articles, projects, videos).

Purpose: Visitors can instantly find relevant content using Thai or mixed Thai-English queries without any server-side infrastructure.
Output: Working search feature accessible from every page via header button and Cmd/Ctrl+K shortcut.
</objective>

<execution_context>
@/Users/ohmmingrath/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ohmmingrath/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-search-and-performance/06-RESEARCH.md

Key existing files:
@astro.config.mjs
@src/layouts/BaseLayout.astro
@src/layouts/ArticleLayout.astro
@src/layouts/ProjectLayout.astro
@src/layouts/VideoLayout.astro
@src/components/common/Header.astro
@src/styles/global.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install astro-pagefind, configure integration, and add content indexing attributes</name>
  <files>
    package.json
    astro.config.mjs
    src/layouts/ArticleLayout.astro
    src/layouts/ProjectLayout.astro
    src/layouts/VideoLayout.astro
  </files>
  <action>
1. Install astro-pagefind:
   ```bash
   npm install astro-pagefind
   ```

2. Register pagefind integration in astro.config.mjs:
   ```typescript
   import pagefind from "astro-pagefind";
   // Add to integrations array: [preact(), sitemap(), pagefind()]
   ```

3. Add `data-pagefind-body` to content layouts and `data-pagefind-ignore` to UI chrome:

   **ArticleLayout.astro:**
   - Add `data-pagefind-body` to the `<article>` element
   - Add `data-pagefind-meta="title"` to the `<h1>` element
   - Wrap ArticleMeta, video embed, and TableOfContents sections in `data-pagefind-ignore` spans/divs
   - The prose body div (with `<slot />`) is the primary searchable content -- no changes needed there
   - Add a hidden `data-pagefind-filter="content_type"` element with value "article"

   **ProjectLayout.astro:**
   - Add `data-pagefind-body` to the `<article>` element
   - Add `data-pagefind-meta="title"` to the `<h1>` element
   - Wrap the meta row and metric highlight box in `data-pagefind-ignore`
   - Add a hidden `data-pagefind-filter="content_type"` element with value "project"

   **VideoLayout.astro:**
   - Add `data-pagefind-body` to the `<article>` element
   - Add `data-pagefind-meta="title"` to the `<h1>` element
   - Wrap the meta row, YouTube facade, and CompanionArticleLink in `data-pagefind-ignore`
   - Add a hidden `data-pagefind-filter="content_type"` element with value "video"

   The "back to ..." nav links at bottom of each layout should also get `data-pagefind-ignore`.

   IMPORTANT: Once `data-pagefind-body` is on ANY page, pages without it are excluded. This is desired -- homepage, contact, and listing pages don't need to be in search results. Only individual content pages (articles, projects, videos) should be searchable.
  </action>
  <verify>
    Run `npm run build` -- build should succeed with Pagefind indexing output showing indexed pages.
    Check build log for "Indexed X pages" line confirming articles + projects + videos are indexed.
  </verify>
  <done>
    astro-pagefind installed and registered, all three content layouts have data-pagefind-body with proper ignore zones, build completes with Pagefind indexing step.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SearchDialog component, add search trigger to Header, and theme Pagefind CSS</name>
  <files>
    src/components/search/SearchDialog.astro
    src/components/common/Header.astro
    src/layouts/BaseLayout.astro
    src/styles/global.css
  </files>
  <action>
1. Create `src/components/search/SearchDialog.astro`:
   - Use native `<dialog>` element with id="search-dialog"
   - Include a `<div id="pagefind-container"></div>` inside the dialog
   - Add a close button (X) in the dialog top-right corner
   - Dialog should have a max-width (e.g., 40rem), be vertically centered with some top offset, and have rounded corners matching the site design
   - Style the dialog backdrop with semi-transparent overlay
   - Script section:
     - Listen for Cmd/Ctrl+K to toggle dialog (preventDefault to block browser default)
     - Listen for Escape to close (native dialog behavior, but ensure cleanup)
     - On first dialog open: lazy-load `@pagefind/default-ui` via dynamic `import()`, instantiate `new PagefindUI({ element: '#pagefind-container', showSubResults: true, showImages: false, autofocus: true })`
     - Track initialization with a `let initialized = false` flag so it only loads once
     - Add click-outside-to-close: clicking the dialog backdrop (dialog element itself, not content) closes it
     - Register `astro:after-swap` listener for view transitions compatibility

   Key dialog open pattern -- use a `show` event listener on the dialog OR check after `showModal()`:
   ```javascript
   // Lazy-load on first open
   dialog.addEventListener('click', (e) => {
     if (e.target === dialog) dialog.close(); // click-outside
   });
   ```
   For initialization, trigger it right after `dialog.showModal()` since the `<dialog>` `open` event is unreliable cross-browser. Use a wrapper function:
   ```javascript
   async function openSearch() {
     dialog.showModal();
     if (!initialized) {
       const { PagefindUI } = await import('/pagefind/pagefind-ui.js');
       new PagefindUI({ element: '#pagefind-container', showSubResults: true, showImages: false, autofocus: true });
       initialized = true;
     }
     // Focus the search input after init
     setTimeout(() => {
       dialog.querySelector('input')?.focus();
     }, 100);
   }
   ```

2. Update `src/components/common/Header.astro`:
   - Add a search trigger button BEFORE the ContactLinks div in the right-side actions area
   - Button: `id="search-trigger"`, `type="button"`, `aria-label="Search"`
   - Icon: Heroicons magnifying-glass outline SVG (24x24)
   - Style: same as other header icon buttons (p-2 rounded-lg text-surface-600 etc.)
   - Add a small `<kbd>` hint showing "âŒ˜K" on desktop (hidden on mobile via `hidden md:inline`)
   - The button should be visible on both mobile and desktop (search is useful everywhere)

3. Update `src/layouts/BaseLayout.astro`:
   - Import and render `<SearchDialog />` in the body, after `<MobileNav />` and before `<main>`

4. Add Pagefind CSS theme variables to `src/styles/global.css`:
   - Add at the end of the file (after the existing @layer components block):
   ```css
   /* === Pagefind search theme === */
   :root {
     --pagefind-ui-scale: 0.9;
     --pagefind-ui-primary: oklch(0.55 0.18 240);
     --pagefind-ui-background: oklch(0.985 0.004 80);
     --pagefind-ui-border: oklch(0.925 0.007 80);
     --pagefind-ui-tag: oklch(0.93 0.03 240);
     --pagefind-ui-text: oklch(0.2 0.008 80);
     --pagefind-ui-font: "Noto Sans Thai Variable", "Inter Variable", ui-sans-serif, sans-serif;
     --pagefind-ui-border-radius: 0.5rem;
   }

   .dark {
     --pagefind-ui-primary: oklch(0.68 0.14 240);
     --pagefind-ui-background: oklch(0.14 0.006 80);
     --pagefind-ui-border: oklch(0.27 0.01 75);
     --pagefind-ui-tag: oklch(0.27 0.1 240);
     --pagefind-ui-text: oklch(0.965 0.005 80);
   }
   ```
   These values match the existing OKLCH design tokens from the @theme block.
  </action>
  <verify>
    Run `npm run build` -- build succeeds.
    Visually inspect the built output: check that `/pagefind/` directory exists in `dist/`.
    Run `npm run preview` and verify:
    - Search icon appears in header
    - Cmd/Ctrl+K opens the search dialog
    - Typing a Thai query returns results from articles/projects/videos
    - Dialog closes on Escape and click-outside
    - Pagefind UI matches site theme (dark and light modes)
  </verify>
  <done>
    Search dialog opens via header button and Cmd/Ctrl+K, Pagefind UI lazy-loads on first open, results display for Thai queries, CSS theme matches site design system in both modes.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors, Pagefind indexing output shows indexed pages
2. `npm run preview` serves the site with functional search
3. Search for a Thai term from a seed article returns the expected article
4. Search for an English term mixed with Thai returns relevant results
5. Navigation chrome (header, footer, TOC) does not appear in search results
6. Search dialog opens/closes correctly (button, Cmd/Ctrl+K, Escape, click-outside)
7. Dark mode: search UI colors match the site theme
</verification>

<success_criteria>
- Pagefind indexes all content at build time (SRCH-01)
- Search returns relevant results for Thai and mixed queries (SRCH-02)
- Search is accessible from every page via header and keyboard shortcut
- No runtime performance impact -- Pagefind JS/WASM loads only when search is opened
</success_criteria>

<output>
After completion, create `.planning/phases/06-search-and-performance/06-01-SUMMARY.md`
</output>
